<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Petcare</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div th:replace="fragments/header :: navbar"></div>

<div class="container">
    <h1>Panel de administraci칩n</h1>
    
    <div class="row mt-4">
        
        <div class="col-md-6">
            <div class="row">
                
                <div class="col-6 mb-3">
                    <div class="card text-bg-primary">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-users me-2"></i>Usuarios</h5>
                            <p class="card-text fs-3" th:text="${numUsuarios}">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="card text-bg-success">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-dog me-2"></i>Mascotas</h5>
                            <p class="card-text fs-3" th:text="${numMascotas}">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-6 mb-3">
                    <div class="card text-bg-warning">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-calendar-check me-2"></i>Citas</h5>
                            <p class="card-text fs-3" th:text="${numCitas}">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="card" style="background-color: #438a56; color: white;">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-user-md me-2"></i>Veterinarios</h5>
                            <p class="card-text fs-3" th:text="${numVeterinarios}">0</p>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100"> <div class="card-header bg-light">
                    <h4 class="mb-0">游늵 Resumen Total de Entidades</h4>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="totalesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    </div>
    
    <div class="container mt-5">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentTab == 'mascotas'} ? 'active'" th:href="@{/admin(tab='mascotas')}">Mascotas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentTab == 'veterinarios'} ? 'active'" th:href="@{/admin(tab='veterinarios')}">Veterinarios</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentTab == 'usuarios'} ? 'active'" th:href="@{/admin(tab='usuarios')}">Usuarios</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentTab == 'duenos'} ? 'active'" th:href="@{/admin(tab='duenos')}">Due침os</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentTab == 'citas'} ? 'active'" th:href="@{/admin(tab='citas')}">Citas</a>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <div class="tab-pane fade" th:classappend="${currentTab == 'mascotas'} ? 'show active'" id="mascotas-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="m-0">Listado de Mascotas</h1>
                    <div class="d-flex gap-2">
                        <a href="/admin/mascotas/export/csv" class="btn btn-outline-primary">Exportar (CSV)</a>
                        <a href="/admin/mascotas/export/pdf" class="btn btn-outline-danger">Exportar (PDF)</a>
                        <a class="btn btn-success" href="/mascotas/nueva">A침adir mascota</a>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">B칰squeda y Filtrado Avanzado</h5>
                        <form method="get" th:action="@{/admin}" class="row g-3">
                             <input type="hidden" name="tab" value="mascotas">
                            <div class="col-md-6">
                                <label for="especieFilter" class="form-label">Filtrar por tipo de animal:</label>
                                <select class="form-select" id="especieFilter" name="especie">
                                    <option value="">-- Todos los tipos --</option>
                                    <option th:each="esp : ${especies}" th:value="${esp}" th:text="${esp}"
                                        th:selected="${especieFiltro == esp}"></option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Filtrar
                                </button>
                                <a th:href="@{/admin(tab='mascotas')}" class="btn btn-secondary">
                                    <i class="fas fa-redo me-1"></i>Limpiar filtro
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Especie</th>
                            <th>Peso</th>
                            <th>Foto</th>
                            <th>Due침o</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="m : ${mascotas.content}">
                            <td th:text="${m.id}"></td>
                            <td th:text="${m.nombre}"></td>
                            <td th:text="${m.especie}"></td>
                            <td th:text="${m.peso != null ? m.peso + ' kg' : 'N/A'}"></td>
                            <td>
                                <img th:if="${m.fotoUrl != null}" th:src="@{${m.fotoUrl}}" alt="Foto de mascota"
                                    style="max-width: 100px; max-height: 100px;" class="img-thumbnail">
                                <span th:if="${m.fotoUrl == null}">Sin foto</span>
                            </td>
                            <td th:text="${m.dueno != null ? m.dueno.nombre : 'Sin due침o'}"></td>
                            <td>
                                <a th:href="@{'/mascotas/' + ${m.id} + '/editar'}" class="btn btn-sm btn-primary me-1">
                                    <i class="fas fa-edit me-1"></i>Editar
                                </a>
                                <a th:href="@{'/mascotas/' + ${m.id} + '/eliminar'}" class="btn btn-sm btn-danger me-1"
                                    onclick="return confirm('쮼st치s seguro de eliminar esta mascota?');">
                                    <i class="fas fa-trash me-1"></i>Eliminar
                                </a>
                                <a th:href="@{'/admin/mascota/' + ${m.id}}" class="btn btn-sm btn-info me-1">
                                    <i class="fas fa-eye me-1"></i>Ver detalles
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <nav th:if="${mascotas.totalPages > 1}">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${mascotas.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='mascotas', page=${mascotas.number - 1}, size=${mascotas.size}, especie=${especieFiltro})}">Anterior</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, mascotas.totalPages - 1)}" th:classappend="${i == mascotas.number} ? 'active'">
                            <a class="page-link" th:href="@{/admin(tab='mascotas', page=${i}, size=${mascotas.size}, especie=${especieFiltro})}" th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${mascotas.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='mascotas', page=${mascotas.number + 1}, size=${mascotas.size}, especie=${especieFiltro})}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="tab-pane fade" th:classappend="${currentTab == 'veterinarios'} ? 'show active'" id="veterinarios-tab">
                 <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Especialidad</th>
                            <th>Email</th>
                            <th>Direcci칩n</th>
                            <th>Ciudad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="v : ${veterinarios.content}">
                            <td th:text="${v.id}"></td>
                            <td th:text="${v.nombre}"></td>
                            <td th:text="${v.especialidad}"></td>
                            <td th:text="${v.email}"></td>
                            <td th:text="${v.direccion}"></td>
                            <td th:text="${v.ciudad}"></td>
                        </tr>
                    </tbody>
                </table>
                <nav th:if="${veterinarios.totalPages > 1}">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${veterinarios.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='veterinarios', page=${veterinarios.number - 1}, size=${veterinarios.size})}">Anterior</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, veterinarios.totalPages - 1)}" th:classappend="${i == veterinarios.number} ? 'active'">
                            <a class="page-link" th:href="@{/admin(tab='veterinarios', page=${i}, size=${veterinarios.size})}" th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${veterinarios.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='veterinarios', page=${veterinarios.number + 1}, size=${veterinarios.size})}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="tab-pane fade" th:classappend="${currentTab == 'usuarios'} ? 'show active'" id="usuarios-tab">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Provider</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="u : ${usuarios.content}">
                            <td th:text="${u.id}"></td>
                            <td th:text="${u.name}"></td>
                            <td th:text="${u.email}"></td>
                            <td th:text="${u.provider}"></td>
                        </tr>
                    </tbody>
                </table>
                <nav th:if="${usuarios.totalPages > 1}">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${usuarios.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='usuarios', page=${usuarios.number - 1}, size=${usuarios.size})}">Anterior</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, usuarios.totalPages - 1)}" th:classappend="${i == usuarios.number} ? 'active'">
                            <a class="page-link" th:href="@{/admin(tab='usuarios', page=${i}, size=${usuarios.size})}" th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${usuarios.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='usuarios', page=${usuarios.number + 1}, size=${usuarios.size})}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="tab-pane fade" th:classappend="${currentTab == 'duenos'} ? 'show active'" id="duenos-tab">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tel칠fono</th>
                            <th>Direcci칩n</th>
                            <th>Ciudad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="d : ${duenos.content}">
                            <td th:text="${d.id}"></td>
                            <td th:text="${d.nombre}"></td>
                            <td th:text="${d.email}"></td>
                            <td th:text="${d.telefono}"></td>
                            <td th:text="${d.direccion}"></td>
                            <td th:text="${d.ciudad}"></td>
                        </tr>
                    </tbody>
                </table>
                <nav th:if="${duenos.totalPages > 1}">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${duenos.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='duenos', page=${duenos.number - 1}, size=${duenos.size})}">Anterior</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, duenos.totalPages - 1)}" th:classappend="${i == duenos.number} ? 'active'">
                            <a class="page-link" th:href="@{/admin(tab='duenos', page=${i}, size=${duenos.size})}" th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${duenos.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='duenos', page=${duenos.number + 1}, size=${duenos.size})}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="tab-pane fade" th:classappend="${currentTab == 'citas'} ? 'show active'" id="citas-tab">
                 <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Mascota</th>
                            <th>Due침o</th>
                            <th>Veterinario</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="c : ${citas.content}">
                            <td th:text="${c.id}"></td>
                            <td th:text="${#temporals.format(c.fechaHora, 'dd-MM-yyyy HH:mm')}"></td>
                            <td th:text="${c.estado}"></td>
                            <td th:text="${c.mascota.nombre}"></td>
                            <td th:text="${c.mascota.dueno != null ? c.mascota.dueno.nombre : 'Sin due침o'}"></td>
                            <td th:text="${c.veterinario.nombre}"></td>
                        </tr>
                    </tbody>
                </table>
                <nav th:if="${citas.totalPages > 1}">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${citas.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='citas', page=${citas.number - 1}, size=${citas.size})}">Anterior</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, citas.totalPages - 1)}" th:classappend="${i == citas.number} ? 'active'">
                            <a class="page-link" th:href="@{/admin(tab='citas', page=${i}, size=${citas.size})}" th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${citas.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin(tab='citas', page=${citas.number + 1}, size=${citas.size})}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <div th:replace="fragments/footer :: footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/

        // 1. Obtener los datos del modelo de Thymeleaf
        const numUsuarios = [[${numUsuarios}]];
        const numMascotas = [[${numMascotas}]];
        const numCitas = [[${numCitas}]];
        const numVeterinarios = [[${numVeterinarios}]];

        // 2. Preparar los datos para Chart.js
        const datosTotales = {
            labels: ['Usuarios', 'Mascotas', 'Citas', 'Veterinarios'],
            datasets: [{
                label: 'Cantidad Total',
                data: [numUsuarios, numMascotas, numCitas, numVeterinarios],
                backgroundColor: [
                    'rgba(13, 110, 253, 0.7)',
                    'rgba(25, 135, 84, 0.7)',
                    'rgba(255, 193, 7, 0.7)',
                    'rgba(67, 138, 86, 0.7)'
                ],
                // ... m치s configuraci칩n de estilo ...
                borderWidth: 1
            }]
        };

        // 3. Configurar el gr치fico
        const config = {
            type: 'bar', // Gr치fico de barras
            data: datosTotales,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'N칰mero de Entidades'
                        },
                        // Aseguramos que solo muestre n칰meros enteros en el eje Y
                        ticks: {
                            callback: function(value) {
                                if (Number.isInteger(value)) {
                                    return value;
                                }
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false 
                    },
                    title: {
                        display: true,
                        text: 'Comparativa de Entidades Registradas'
                    }
                }
            }
        };

        // 4. Renderizar el gr치fico
        window.addEventListener('load', function() {
            const ctx = document.getElementById('totalesChart').getContext('2d');
            new Chart(ctx, config);
        });

        /*]]>*/
    </script>
</body>

</html>